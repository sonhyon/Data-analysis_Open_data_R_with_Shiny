#3-1 크롤링 준비 (*크롤링: 웹사이트에서 자동으로 데이터를 수집하는 기술)

#1단계: 작업폴더 설정
install.packages("rstudioapi") #rstudioapi는 현재 파일 경로 가져오기, 파일 열기, 스크립트 실행 등의 작업을 자동화를 가능케 함
setwd(dirname(rstudioapi::getSourceEditorContext()$path)) #setwd()는 괄호 안에 위치를 작업 폴더로 설정 / 괄호 안 내용은 파일 전체 경로에서 폴더 경로만 추출
getwd() #getwd()는 설정된 작업 위치를 추출

#2단계: 수집 대상 지역 설정하기
loc <- read.csv("./01_code/sigun_code/sigun_code.csv", fileEncoding="UTF-8") #지역 코드 불러오기 (25개 자치구)
loc$code <- as.character(loc$code) #행정구역명을 문자 변환

#3단계: 수집 기간 설정하기
datelist <- seq(from = as.Date('2021-01-01'), #2021년을 12개월로 구분
                to = as.Date('2021-12-31'),
                by = '1 month')
datelist <- format(datelist, format = '%Y%m') #format()은 숫자, 날짜, 문자열 등의 출력 형식을 조정할 때 사용하는 함수 / YYYY-MM-DD를 YYYYMM 형식으로 변환

#4단계: 인증키 입력하기
service_key <- "inDGnpEIXx2RB1j6t0qW9A2DF0hXFbfw%2F%2BDBMdy2NteEHgan1Ftm469yVLTE%2FLkPMC57JGpJNxJHmvaYWMO5PA%3D%3D"



#3-2 요청 목록 생성: 자료를 어떻게 요청할까? - API에 자료를 요청하기

#1단계: 요청 목록 만들기
url_list <- list()
cnt <- 0

#2단계: 요청 목록 채우기
for (i in 1:nrow(loc)) { #25개 자치구 외부 반복
  for (j in 1:length(datelist)) { #12개월 내부 반복
    cnt <- cnt + 1
    url_list[cnt] <- paste0("https://apis.data.go.kr/1613000/RTMSDataSvcAptTrade/getRTMSDataSvcAptTrade?", #서비스URL
                            "LAWD_CD=", loc[i,1], #지역코드
                            "&DEAL_YMD=", datelist[j], #수집 월
                            "&numOfRows=", 100, #한 번에 가져올 최대 자료 수
                            "&serviceKey=", service_key) #인증키
  }
  Sys.sleep(0.1) #딜레이 0.1초
  msg <- paste0("[", i, "/", nrow(loc), "] ", loc[i,3], "의 크롤링 목록이 생성됨 => 총 [", cnt,"] 건") #알림 메시지
  cat(msg, "\n\n") #띄어쓰기
}

length(url_list)
browseURL(paste0(url_list[1]))


